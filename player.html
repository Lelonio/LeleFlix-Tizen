<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeleFlix Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: black;
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #e50914;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 30px 40px 50px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .controls-overlay.visible {
            opacity: 1;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: #e50914;
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: #ccc;
        }

        .controls-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:focus {
            outline: none;
            background: #e50914;
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }

        .video-info {
            position: absolute;
            top: 30px;
            left: 30px;
            right: 30px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-info.visible {
            opacity: 1;
        }

        .video-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .video-subtitle {
            font-size: 16px;
            color: #ccc;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .controls-overlay.visible ~ .close-btn {
            opacity: 1;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            display: none;
        }

        .error-message i {
            font-size: 40px;
            color: #e50914;
            margin-bottom: 15px;
        }

        .error-message p {
            margin-bottom: 20px;
            font-size: 16px;
        }

        .error-btn {
            background: #e50914;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .error-btn:hover {
            background: #b2070f;
        }

        @media (min-width: 768px) {
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .control-btn.play-pause {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }
            
            .video-title {
                font-size: 32px;
            }
            
            .video-subtitle {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="videoPlayer" preload="auto"></video>
        
        <div class="loading-spinner" id="loadingSpinner">
            <i class="fas fa-spinner"></i>
        </div>
        
        <div class="video-info" id="videoInfo">
            <div class="video-title" id="videoTitle"></div>
            <div class="video-subtitle" id="videoSubtitle"></div>
        </div>
        
        <button class="close-btn" id="closeBtn" title="Chiudi">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="controls-overlay" id="controlsOverlay">
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-info">
                    <span id="currentTime">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
            
            <div class="controls-buttons">
                <button class="control-btn" id="rewindBtn" title="Riavvolgi 10s">
                    <i class="fas fa-backward"></i>
                </button>
                <button class="control-btn play-pause" id="playPauseBtn" title="Play/Pausa">
                    <i class="fas fa-play" id="playPauseIcon"></i>
                </button>
                <button class="control-btn" id="forwardBtn" title="Avanti 10s">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="errorText"></p>
            <button class="error-btn" id="retryBtn">Riprova</button>
            <button class="error-btn" id="closeErrorBtn" style="margin-left: 10px;">Chiudi</button>
        </div>
    </div>

    <script>
var video = document.getElementById('videoPlayer');
var playPauseBtn = document.getElementById('playPauseBtn');
var playPauseIcon = document.getElementById('playPauseIcon');
var rewindBtn = document.getElementById('rewindBtn');
var forwardBtn = document.getElementById('forwardBtn');
var closeBtn = document.getElementById('closeBtn');
var controlsOverlay = document.getElementById('controlsOverlay');
var videoInfo = document.getElementById('videoInfo');
var progressContainer = document.getElementById('progressContainer');
var progressFill = document.getElementById('progressFill');
var currentTimeSpan = document.getElementById('currentTime');
var durationSpan = document.getElementById('duration');
var videoTitle = document.getElementById('videoTitle');
var videoSubtitle = document.getElementById('videoSubtitle');
var loadingSpinner = document.getElementById('loadingSpinner');
var errorMessage = document.getElementById('errorMessage');
var errorText = document.getElementById('errorText');
var retryBtn = document.getElementById('retryBtn');
var closeErrorBtn = document.getElementById('closeErrorBtn');

var hls;
var controlsVisible = false;
var hideControlsTimer;
var isSeeking = false;
var currentToken = null;

document.addEventListener('DOMContentLoaded', init);

function init() {
    var params = getUrlParams();
    var type = params.type || 'movie';
    currentToken = Date.now();
    loadingSpinner.style.display = 'block';

    if (type === 'movie') {
        loadMovie(params.movieId);
    } else if (type === 'tv') {
        loadTVEpisode(params.tvId, params.season, params.episode);
    } else {
        showError("Tipo di contenuto non supportato");
    }
}

function getUrlParams() {
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    var params = {};
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
    }
    return params;
}

function loadMovie(movieId) {
    if (!movieId) {
        showError("Parametro movieId mancante");
        return;
    }

    fetch("https://api.themoviedb.org/3/movie/" + movieId + "?api_key=1e8c9083f94c62dd66fb2105cd7b613b&language=it-IT")
        .then(function (res) { return res.json(); })
        .then(function (tmdb) {
            if (!tmdb || !tmdb.title) throw new Error("Errore TMDB");

            videoTitle.textContent = tmdb.title;
            videoSubtitle.textContent = tmdb.release_date ? tmdb.release_date.substring(0, 4) : '';

            return fetch("https://api.leleflix.store/proxy/movie/" + movieId);
        })
        .then(function (res) { return res.json(); })
        .then(function (streamData) {
            if (!streamData || !streamData.url) throw new Error("Nessun URL disponibile");

            setupEventListeners();
            startPlayback(streamData.url);
        })
        .catch(function (err) {
            console.error(err);
            showError("Errore durante il caricamento del film");
        });
}

function loadTVEpisode(tvId, seasonNumber, episodeNumber) {
    if (!tvId || !seasonNumber || !episodeNumber) {
        showError("Parametri mancanti per la serie TV");
        return;
    }

    // Prima otteniamo i metadati dell'episodio
    fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}/episode/${episodeNumber}?api_key=1e8c9083f94c62dd66fb2105cd7b613b&language=it-IT`)
        .then(function (res) { return res.json(); })
        .then(function (episodeData) {
            if (!episodeData || !episodeData.name) throw new Error("Errore nel caricamento dei metadati");

            // Ottieni anche i dati della serie per il titolo
            return fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=1e8c9083f94c62dd66fb2105cd7b613b&language=it-IT`)
                .then(function (res) { return res.json(); })
                .then(function (showData) {
                    videoTitle.textContent = showData.name || 'Serie TV';
                    videoSubtitle.textContent = `S${seasonNumber}E${episodeNumber} • ${episodeData.name}`;
                    
                    return fetch(`https://api.leleflix.store/proxy/series/${tvId}/${seasonNumber}/${episodeNumber}`);
                });
        })
        .then(function (res) { return res.json(); })
        .then(function (streamData) {
            if (!streamData || !streamData.url) throw new Error("Nessun URL disponibile");

            setupEventListeners();
            startPlayback(streamData.url);
        })
        .catch(function (err) {
            console.error(err);
            showError("Errore durante il caricamento dell'episodio");
        });
}

function setupEventListeners() {
    playPauseBtn.addEventListener('click', togglePlayPause);
    rewindBtn.addEventListener('click', function () { seek(-10); });
    forwardBtn.addEventListener('click', function () { seek(10); });
    closeBtn.addEventListener('click', closePlayer);
    retryBtn.addEventListener('click', function() {
        var params = getUrlParams();
        if (params.type === 'movie') {
            loadMovie(params.movieId);
        } else {
            loadTVEpisode(params.tvId, params.season, params.episode);
        }
    });
    closeErrorBtn.addEventListener('click', closePlayer);
    progressContainer.addEventListener('click', handleProgressClick);
    video.addEventListener('click', toggleControls);
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('mousemove', showControls);
    video.addEventListener('timeupdate', updateProgress);
}

function startPlayback(streamUrl) {
    errorMessage.style.display = 'none';
    loadingSpinner.style.display = 'block';

    if (Hls.isSupported()) {
        if (hls) hls.destroy();

        hls = new Hls({
            maxBufferLength: 30,
            maxMaxBufferLength: 60,
            enableWorker: true
        });

        hls.loadSource(streamUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            loadingSpinner.style.display = 'none';
            video.play().catch(function (e) {
                console.log("Autoplay prevented:", e);
            });
            
            // Prova a selezionare la qualità migliore disponibile
            const lvl = hls.levels.findIndex(l => l.height === 1080);
            if (lvl >= 0) hls.currentLevel = lvl;
        });

        hls.on(Hls.Events.ERROR, function (event, data) {
            if (data.fatal) {
                console.error("HLS fatal error:", data);
                showError("Errore nella riproduzione video.");
            }
        });

    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streamUrl;
        video.addEventListener('loadedmetadata', function () {
            loadingSpinner.style.display = 'none';
            video.play().catch(function (e) {
                console.log("Autoplay prevented:", e);
            });
        });
    } else {
        showError("Il tuo browser non supporta HLS.");
    }
}

function togglePlayPause() {
    if (video.paused) {
        video.play();
        playPauseIcon.className = 'fas fa-pause';
    } else {
        video.pause();
        playPauseIcon.className = 'fas fa-play';
    }
    showControls();
}

function seek(seconds) {
    video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
    showControls();
}

function handleProgressClick(e) {
    var rect = progressContainer.getBoundingClientRect();
    var pos = (e.clientX - rect.left) / rect.width;
    video.currentTime = pos * video.duration;
    showControls();
}

function updateProgress() {
    if (!isSeeking && video.duration) {
        var percent = (video.currentTime / video.duration) * 100;
        progressFill.style.width = percent + '%';
        currentTimeSpan.textContent = formatTime(video.currentTime);
        durationSpan.textContent = formatTime(video.duration);
    }
}

function formatTime(seconds) {
    var mins = Math.floor(seconds / 60);
    var secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function toggleControls() {
    if (controlsVisible) {
        hideControls();
    } else {
        showControls();
    }
}

function showControls() {
    controlsVisible = true;
    controlsOverlay.classList.add('visible');
    videoInfo.classList.add('visible');
    closeBtn.style.opacity = '1';
    resetControlsTimer();
}

function hideControls() {
    controlsVisible = false;
    controlsOverlay.classList.remove('visible');
    videoInfo.classList.remove('visible');
    closeBtn.style.opacity = '0';
}

function resetControlsTimer() {
    clearTimeout(hideControlsTimer);
    hideControlsTimer = setTimeout(hideControls, 3000);
}

function handleKeyDown(e) {
    switch (e.key) {
        case ' ':
        case 'Enter':
            togglePlayPause();
            break;
        case 'ArrowLeft':
            seek(-10);
            break;
        case 'ArrowRight':
            seek(10);
            break;
        case 'f':
        case 'F':
            toggleFullscreen();
            break;
    }
    
    // Tasto "Return" su Tizen
    if (e.keyCode === 10009) {
        e.preventDefault();
        closePlayer();
    }
}

function showError(message) {
    errorText.textContent = message;
    errorMessage.style.display = 'block';
    loadingSpinner.style.display = 'none';
}

function closePlayer() {
    if (hls) {
        hls.destroy();
    }
    window.location.href = "tv.html";
}

function toggleFullscreen() {
    var videoContainer = document.querySelector('.video-container');
    if (!document.fullscreenElement) {
        if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen();
        } else if (videoContainer.webkitRequestFullscreen) { /* Safari */
            videoContainer.webkitRequestFullscreen();
        } else if (videoContainer.msRequestFullscreen) { /* IE11 */
            videoContainer.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { /* Safari */
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { /* IE11 */
            document.msExitFullscreen();
        }
    }
}
</script>
</body>
</html>